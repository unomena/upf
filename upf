#!/bin/bash

# UPF - Uncomplicated Port Forwarding
# Wrapper script that handles sudo automatically
#
# This wrapper ensures the actual UPF core script runs with root privileges
# without requiring users to remember to use sudo

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Path to the core script
# Check if we're running from the development directory
if [[ -f "$(dirname "$0")/upf-core" ]]; then
    CORE_SCRIPT="$(dirname "$0")/upf-core"
else
    CORE_SCRIPT="/usr/local/bin/upf-core"
fi

# Check if core script exists
if [[ ! -f "$CORE_SCRIPT" ]]; then
    echo -e "${RED}Error: UPF core script not found at $CORE_SCRIPT${NC}"
    echo "Please reinstall UPF"
    exit 1
fi

# Check if already running as root
if [[ $EUID -eq 0 ]]; then
    # Already root, just run the core script directly
    exec "$CORE_SCRIPT" "$@"
else
    # Not root, need to use sudo
    # Check if sudo is available
    if ! command -v sudo &> /dev/null; then
        echo -e "${RED}Error: sudo is required but not installed${NC}"
        echo "Please install sudo or run as root"
        exit 1
    fi
    
    # Special handling for commands that don't need sudo
    case "$1" in
        help|-h|--help|"")
            # Help doesn't need sudo, but we'll let the core script handle it
            # for consistency in output
            ;;
    esac
    
    # Run the core script with sudo
    # Use -E to preserve environment if needed
    exec sudo "$CORE_SCRIPT" "$@"
fi